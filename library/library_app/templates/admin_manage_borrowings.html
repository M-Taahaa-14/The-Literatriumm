{% extends 'admin_base.html' %}
{% load static %}
{% block content %}
{% if messages %}
  <div class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3" style="max-width: 600px;">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

<h2 class="mb-4">ðŸ“– Manage Borrowings</h2>

<!-- Filters -->
<form method="get" class="row mb-4 g-2">
  <div class="col-md-3">
    <select name="status" class="form-select">
      <option value="">-- Filter Status --</option>
      <option value="returned" {% if request.GET.status == 'returned' %}selected{% endif %}>Returned</option>
      <option value="unreturned" {% if request.GET.status == 'unreturned' %}selected{% endif %}>Unreturned</option>
      <option value="overdue" {% if request.GET.status == 'overdue' %}selected{% endif %}>Overdue</option>
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-outline-primary w-100">Apply</button>
  </div>
</form>

<table class="table table-bordered table-hover">
  <thead class="table-light">
    <tr>
      <th>User</th>
      <th>Book</th>
      <th>Borrowed On</th>
      <th>Return Due</th>
      <th>Returned?</th>
      <th>Fine</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for borrow in borrowings %}
    <tr>
      <td>{{ borrow.user.username }}</td>
      <td>{{ borrow.book.title }}</td>
      <td>{{ borrow.borrow_date|date:"M d, Y" }}</td>
      <td class="{% if not borrow.is_returned and borrow.due_date and borrow.due_date < now %}text-danger fw-bold{% endif %}">
        {% if borrow.due_date %}
          {{ borrow.due_date|date:"M d, Y" }}
        {% else %}
          Not set
        {% endif %}

      </td>
      <td>
        {% if borrow.is_returned %}<span class="badge bg-success">Yes</span>
        {% else %}<span class="badge bg-warning text-dark">No</span>{% endif %}
      </td>
      <td>
        <form method="post" class="d-flex gap-1 align-items-center" action="">
          {% csrf_token %}
          <input type="hidden" name="action" value="fine">
          <input type="hidden" name="borrow_id" value="{{ borrow.id }}">
          <input type="number" step="0.01" name="fine_amount" value="{{ borrow.fine|default_if_none:"0.00" }}" class="form-control form-control-sm" style="width: 80px;">
          <button type="submit" class="btn btn-sm btn-outline-secondary">ðŸ’°</button>
        </form>
      </td>
      <td>
        <div class="d-flex gap-2">
          {% if not borrow.is_returned %}
          <!-- <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="return">
            <input type="hidden" name="borrow_id" value="{{ borrow.id }}">
            <button type="submit" class="btn btn-sm btn-success">Return</button>
          </form> -->
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="reminder">
            <input type="hidden" name="borrow_id" value="{{ borrow.id }}">
            <button type="submit" class="btn btn-sm btn-warning">Reminder</button>
          </form>
          {% endif %}
        </div>
      </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="7" class="text-center text-muted">No borrow records found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}
