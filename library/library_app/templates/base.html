{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Literarium</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    .content-wrapper {
      flex: 1;
    }
    body {
      background: url("/media/backgrounds/books1.png") no-repeat center center fixed;
      background-size: cover;
      background-color: #f8f9fa;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 100vw;
      background-color: rgba(255, 254, 254, 0.45);
      z-index: -1;
    }
    .fade-out {
      opacity: 0;
      transition: opacity 1s ease-out;
    }
    footer {
      background-color: #111;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="content-wrapper">

  <!-- Alerts -->
  {% if messages %}
  <div class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3" style="max-width: 600px;">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" id="msg-alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">Mini Library</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item"><a class="nav-link" href="/books/">Books</a></li>
          <li class="nav-item"><a class="nav-link" href="/my-borrowings/">My Borrowings</a></li>

          {% if user.is_authenticated and profile %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="profileDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="rounded-circle bg-white text-dark fw-bold d-flex justify-content-center align-items-center me-2" style="width: 36px; height: 36px;">
                {{ profile.initials }}
              </div>
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 280px;" aria-labelledby="profileDropdown">
              <li class="dropdown-header text-center">
                <strong>{{ profile.full_name }}</strong><br>
                <small class="text-muted">{{ user.email }}</small>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li class="px-3"><strong>Phone:</strong> {{ profile.phone }}</li>
              <li class="px-3"><strong>Address:</strong> {{ profile.address }}</li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <form method="post" action="{% url 'logout' %}">
                  {% csrf_token %}
                  <button type="submit" class="dropdown-item text-danger">Logout</button>
                </form>
              </li>
            </ul>
          </li>
          <li class="nav-item dropdown me-3">
            <a class="nav-link position-relative" href="#" id="notifDropdown" role="button"
               data-bs-toggle="dropdown" aria-expanded="false" onclick="markAllNotificationsRead()">
              üîî
              {% if unread_count > 0 %}
              <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                  {{ unread_count }}
              </span>
              {% endif %}
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 300px;" aria-labelledby="notifDropdown">
              <li class="dropdown-header fw-bold">Notifications</li>
              {% for note in notifications %}
              <li class="dropdown-item small {% if not note.is_read %}fw-bold{% endif %}">
                <div>{{ note.message }}</div>
                <small class="text-muted">{{ note.created_at|date:"M d, H:i" }}</small>
              </li>
              {% empty %}
              <li class="dropdown-item text-muted small">No notifications</li>
              {% endfor %}
            </ul>
          </li>

          {% else %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="guestDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span class="fs-4">üë§</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="guestDropdown">
              <li><a href="{% url 'login' %}" class="dropdown-item">Login</a></li>
              <li><a href="{% url 'signup' %}" class="dropdown-item">Sign Up</a></li>
            </ul>
          </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    {% block content %}{% endblock %}
  </div>

  </div> <!-- End of .content-wrapper -->

  <!-- Footer -->
  <footer class="bg-dark text-white py-3 text-center">
    <p class="mb-0">&copy; 2025 The Literarium. All rights reserved.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
          alert.classList.add('fade-out');
          setTimeout(() => alert.remove(), 1000);
        });
      }, 3000);
    });

    function markAllNotificationsRead() {
      console.log("üîî markAllNotificationsRead triggered");
      fetch("{% url 'mark_all_notifications_read' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json"
        }
      }).then(response => {
        if (response.ok) {
          console.log("‚úÖ Notifications marked as read");
          const badge = document.getElementById("notif-badge");
          if (badge) {
            badge.style.display = "none";
          }
        } else {
          console.warn("‚ùå Failed to mark notifications");
        }
      });
    }
  </script>
</body>
</html>
