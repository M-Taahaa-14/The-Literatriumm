{% extends 'admin_base.html' %}
{% block content %}
{% if messages %}

  <div class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3 w-100 d-flex justify-content-center" style="pointer-events: none;">
    <div style="max-width: 720px; width: 100%; pointer-events: all;">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} 
                    {% if message.tags == 'error' %} bg-danger text-white border-0 {% endif %} 
                    alert-dismissible fade show shadow text-center fw-semibold"
             role="alert" id="msg-alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<h2 class="mb-4">ðŸ“š Manage Books</h2>

<!-- Search Form -->
<form method="get" class="row mb-4">
  <div class="col-md-8">
    <input type="text" name="q" value="{{ request.GET.q }}" class="form-control" placeholder="Search by title or author">
  </div>
  <div class="col-md-4">
    <button type="submit" class="btn btn-primary w-100">Search</button>
  </div>
</form>

<!-- Add New Book -->
<a href="{% url 'admin_add_book' %}" class="btn btn-success mb-3">âž• Add New Book</a>

<!-- Book Table -->
<table class="table table-bordered table-hover">
  <thead class="table-light">
    <tr>
      <th>Title</th>
      <th>Author</th>
      <th>Category</th>
      <th>Available</th>
      <th>Total</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for book in books %}
    <tr id="book-row-{{ book.id }}">
      <form method="post" action="{% url 'admin_update_book' book.id %}" class="align-middle">
        {% csrf_token %}
        <td>{{ book.title }}</td>
        <td>{{ book.author }}</td>
        <td>
          <select name="category" class="form-select form-select-sm">
            {% for cat in categories %}
            <option value="{{ cat.id }}" {% if cat.id == book.category.id %}selected{% endif %}>
              {{ cat.name }}
            </option>
            {% endfor %}
          </select>
        </td>
        <td>
        <div class="input-group input-group-sm">
            <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('available_{{ book.id }}', -1)">âˆ’</button>
            <input type="number" name="available_copies" id="available_{{ book.id }}"
                class="form-control text-center" value="{{ book.available_copies }}" min="0">
            <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('available_{{ book.id }}', 1)">+</button>
        </div>
        </td>
        <td>
          <div class="input-group input-group-sm">
            <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('total_{{ book.id }}', -1)">âˆ’</button>
            <input type="number" name="total_copies" id="total_{{ book.id }}" class="form-control text-center" value="{{ book.total_copies }}" min="0">
            <button type="button" class="btn btn-outline-secondary" onclick="adjustValue('total_{{ book.id }}', 1)">+</button>
          </div>
        </td>
        <td class="text-nowrap d-flex gap-2">
          <button type="submit" class="btn btn-sm btn-success">Update</button>
      </form>
          <form method="post" action="{% url 'admin_delete_book' book.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="6" class="text-center">No books found.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>


<script>
function adjustValue(id, delta) {
    const input = document.getElementById(id);
    let newVal = parseInt(input.value || 0) + delta;
    if (newVal < 0) newVal = 0;
    input.value = newVal;
}

document.addEventListener('DOMContentLoaded', () => {
  const alertEl = document.getElementById('msg-alert');
  if (alertEl) {
    setTimeout(() => {
      const alertInstance = bootstrap.Alert.getOrCreateInstance(alertEl);
      alertInstance.close();
    }, 5000); 
  }
});
</script>


{% endblock %}